dq_check_id,Check,Database_name,table_name,primary_key_cols,sql_fr_run,priority,threshold,run_seq
101,product_count,com_us_lake,dagg_cdit_redist,row_id,"with tmp (select max(abs((cur_cnt-prv_cnt)/metric*100)) as metric from ((select count(1) as cur_cnt,pr.Name_of_Account_End_Customer as product from 
   (SELECT product_name,
CAST(case when source=""BD"" THEN ship_to_org_id ELSE prescriber_id END AS VARCHAR(50))  as  end_cust_mstr_id,
product_name as src_prod_id,gl_date  FROM com_us_lake.dagg_cdit_redist  WHERE  aud_row_stat_ind='0' 
 
) sa 
 join com_us_lake.hem_affiliation_table pr on sa.end_cust_mstr_id = pr.Shire_ID_End_Customer  join com_us_lake.man_lov lv on sa.product_name = lv.lov_code where sa.gl_date between (select min(period_start_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table')  and (select max(period_end_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table') and upper(LOV_DESCRIPTION)='HEMATOLOGY'   group by pr.Name_of_Account_End_Customer) cur cross join (select prv_count as prv_cnt,metric, sub_field_name
 as product from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table') prv on cur.product=prv.product)) select * from tmp	
		 ",P1,10,1
102,product_count,com_us_lake,udef_ic_order_adjustments,id,"with tmp (select max(abs((cur_cnt-prv_cnt)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.Name_of_Account_End_Customer as product from (select gl_date,src_id,product  from (SELECT  product, to_date(gl_date,'MM/dd/yy') gl_date ,customer_master_id src_id
FROM com_us_lake.udef_ic_order_adjustments
WHERE id is NOT NULL) a 
join 
(select   omni_id,cust_profile_key from com_us_hub.ref_cust_profile where scd_curr_ind='Y' group by  omni_id,cust_profile_key) f on  a.src_id=f.omni_id
)  sa
 join com_us_lake.hem_affiliation_table pr on sa.src_id = pr.Shire_ID_End_Customer join com_us_lake.man_lov lv on sa.product = lv.lov_code where sa.gl_date between (select min(period_start_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'udef_ic_order_adjustments-hem_affiliation_table') and (select max(period_end_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'udef_ic_order_adjustments-hem_affiliation_table') and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.Name_of_Account_End_Customer) cur cross join (select prv_count as prv_cnt, metric, sub_field_name as product from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'udef_ic_order_adjustments-hem_affiliation_table') prv on cur.product=prv.product)) select * from tmp",P1,10,2
103,product_count,com_us_lake,bpri_salesordertransactions,doc_number,"
with tmp (select max(abs((cur_cnt-prv_cnt)/metric*100)) as metric from ((select count(1) as cur_cnt,pr.Name_of_Account_End_Customer as product from 
 (select  COALESCE(omni_id,xref_omni_id,tri_omni_id) id ,* from 
(select ltrim(0,sold_to_party)  src_id ,  to_date(Billing_doc__date,'MM/dd/yy')  gl_date
,fr_lov.lov_description Franchise

FROM com_us_lake.BPRI_BillingExtract
BPRI_BillingExtract
INNER JOIN com_us_lake.bpri_salesordertransactions bpri_salesordertransactions

         ON (
         regexp_replace(bpri_salesordertransactions.doc_number,""^0+(?!$)"","""") = regexp_replace(BPRI_BillingExtract.Sales_document,""^0+(?!$)"","""") 
         AND regexp_replace(bpri_salesordertransactions.s_ord_item,""^0+(?!$)"","""") =  regexp_replace(BPRI_BillingExtract.Sales_doc_Item,""^0+(?!$)"","""")
        ) 
             join 
              com_us_lake.man_lov fr_lov
          ON ( regexp_replace(bpri_salesordertransactions.material,""^0+(?!$)"","""") = regexp_replace(fr_lov.LOV_CODE,""^0+(?!$)"","""")  
               AND fr_lov.ENTITY_TYPE=""all"" AND fr_lov.LOOKUP_FIELD='franchise_nm'  AND fr_lov.data_source='SAP'
         ) 
         where   upper(LOV_DESCRIPTION)='HEMATOLOGY'
         )
         a

--(select * from  (select   ltrim(0,sold_to_party)  src_id ,billing_doc__date from  com_us_lake.BPRI_BillingExtract) a 
inner join 


(select distinct  a.omni_id tri_omni_id,ltrim('0',a.src_id) as src_id  from com_us_hub.ref_cust_xref a
left join  com_us_lake.feed_lkp b on upper(a.src_system)=upper(b.src_system) where b.src is not null) d
on a.src_id = d.src_id 
left join 

(select distinct  a.omni_id xref_omni_id ,a.cust_profile_key,a.src_id,upper(b.src) as feed,upper(a.src_system) as src_system  from com_us_hub.ref_cust_xref a
left join  com_us_lake.feed_lkp b on upper(a.src_system)=upper(b.src_system) where b.src is not null) c on 
a.src_id=c.src_id
left join 
(select distinct  omni_id,cust_profile_key from com_us_hub.ref_cust_profile where scd_curr_ind='Y') f on  a.src_id=f.omni_id
 ) sa

 join com_us_lake.hem_affiliation_table pr on sa.id = pr.Shire_ID_End_Customer where sa.gl_date between (select min(period_start_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table')  and (select max(period_end_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table')  group by pr.Name_of_Account_End_Customer) cur cross join (select prv_count as prv_cnt,metric, sub_field_name
 as product from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table') prv on cur.product=prv.product)) select * from tmp	
		 
	--------------------   
with tmp (select max(abs((cur_cnt-prv_cnt)/metric*100)) as metric from ((select count(1) as cur_cnt,pr.Name_of_Account_End_Customer as product from 
   (SELECT 
CAST(case when source=""BD"" THEN ship_to_org_id ELSE prescriber_id END AS VARCHAR(50))  as  end_cust_mstr_id,
product_name as src_prod_id,gl_date  FROM com_us_lake.dagg_cdit_redist  WHERE  aud_row_stat_ind='0' 
 union 
 select  CAST(case when source=""BD"" THEN ship_to_org_id ELSE prescriber_id END AS VARCHAR(50))  as  end_cust_mstr_id,
product_name as src_prod_id,gl_date as gl_d  FROM com_us_lake.cnp_bd_cbk_sls 
 WHERE  aud_row_stat_ind='0'  ) sa 
 join com_us_lake.hem_affiliation_table pr on sa.end_cust_mstr_id = pr.Shire_ID_End_Customer where sa.gl_date between (select min(period_start_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table')  and (select max(period_end_date) from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table')  group by pr.Name_of_Account_End_Customer) cur cross join (select prv_count as prv_cnt,metric, sub_field_name
 as product from com_us_lake.dq_count_table where dq_rule = 'dq_rule_6' and table_name = 'com_us_lake.hem_affiliation_table') prv on cur.product=prv.product)) select * from tmp	

====
insert into com_us_lake.dq_count_table
select 'dq_rule_6','lake','com_us_lake.hem_affiliation_table','Product',product,count,metric,trunc(add_months(current_date,-26),'mm'),date_add(trunc(add_months(current_date,-2),'mm'),-1),current_date,'Daily' from (select sum(cnt) as count,round(avg(cnt),2) as metric,Name_of_Account_End_Customer as product from (select count(1) as cnt,pr.Name_of_Account_End_Customer from

 (SELECT 
CAST(case when source=""BD"" THEN ship_to_org_id ELSE prescriber_id END AS VARCHAR(50))  as  end_cust_mstr_id,
product_name as src_prod_id,gl_date  FROM com_us_lake.dagg_cdit_redist  WHERE  aud_row_stat_ind='0' 
 
)  sa
 join com_us_lake.hem_affiliation_table pr on sa.end_cust_mstr_id = pr.Shire_ID_End_Customer where sa.gl_date between trunc(add_months(current_date,-26),'mm') and date_add(trunc(add_months(current_date,-2),'mm'),-1)  group by pr.Name_of_Account_End_Customer, extract(month from sa.gl_date), extract(year from sa.gl_date)) group by Name_of_Account_End_Customer);",P1,10,3
final_check,final_check,corp_us_lake,generalledger_lineitems_takeda,"LOGSYS,COMP_CODE,CHRT_ACCTS,GL_ACCOUNT,FISCVARNT,FISCPER,AC_DOC_NO,ITEM_NUM","Select case when metric > threshold then 1 else 0 end as res from dq_output_table where entity_id in (101,102,103)",P1,0,4
