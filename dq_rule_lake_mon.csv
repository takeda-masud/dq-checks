dq_check_id,Check,Database_name,table_name,primary_key_cols,sql_fr_run,priority,threshold,run_seq
dq_2411,product_count,com_us_lake,dagg_cdit_redist,row_id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.brand_nm as product from com_us_lake.dagg_cdit_redist sa join com_us_hub.ref_prd_prod pr on sa.product_name = substring_index(pr.prod_id, '_', -1) join com_us_lake.man_lov lv on sa.product_name = lv.lov_code where to_date(sa.gl_date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.brand_nm) cur cross join (select prv_count as prv_cnt, metric, sub_field_name as product from com_us_lake.dq_count_table where rule_key = 2411) prv on cur.product=prv.product)) select * from tmp",P1,10,1
dq_2412,product_count,com_us_lake,cnp_bd_cbk_sls,row_id,"with tmp (select max(abs((cur_cnt-prv_cnt)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.brand_nm as product from com_us_lake.cnp_bd_cbk_sls sa join com_us_hub.ref_prd_prod pr on sa.product_name = substring_index(pr.prod_id, '_', -1) join com_us_lake.man_lov lv on sa.product_name = lv.lov_code where to_date(sa.gl_date,'M/d/y') between  trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.brand_nm) cur cross join (select prv_count as prv_cnt, metric, sub_field_name as product from com_us_lake.dq_count_table where rule_key = 2412) prv on cur.product=prv.product)) select * from tmp",P1,10,2
dq_2413,product_count,com_us_lake,udef_ic_order_adjustments,id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.brand_nm as product from com_us_lake.udef_ic_order_adjustments sa join com_us_hub.ref_prd_prod pr on sa.product = substring_index(pr.prod_id, '_', -1) join com_us_lake.man_lov lv on sa.product = lv.lov_code where to_date(sa.gl_date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.brand_nm) cur cross join (select prv_count as prv_cnt, metric, sub_field_name as product from com_us_lake.dq_count_table where rule_key = 2413) prv on cur.product=prv.product)) select * from tmp",P1,10,3
dq_2414,product_count,com_us_lake,bpri_salesordertransactions,doc_number,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cur_cnt, p.brand_nm as product from com_us_lake.BPRI_BillingExtract bill JOIN com_us_lake.bpri_salesordertransactions sal ON (regexp_replace(sal.doc_number, '^0+(?!$)', '') = regexp_replace(bill.Sales_document, '^0+(?!$)', '') AND regexp_replace(sal.s_ord_item, '^0+(?!$)', '') = regexp_replace(bill.Sales_doc_Item, '^0+(?!$)', '')) INNER JOIN com_us_lake.bpri_materialmasterdata mat ON (sal.material=mat.material) inner JOIN com_us_hub.ref_prd_prod p ON(regexp_replace(mat.material, '^0+(?!$)', '') = regexp_replace(p.prod_id, '^0+(?!$)', '')) join com_us_lake.man_lov lv on regexp_replace(mat.material, '^0+(?!$)', '') = lv.lov_code where to_date(Billing_doc__date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by p.brand_nm) cur cross join (select prv_count as prv_cnt, metric, sub_field_name as product from com_us_lake.dq_count_table where rule_key = 2414) prv on cur.product=prv.product)) select * from tmp",P1,10,4
product_final_check,product_count,corp_us_lake,generalledger_lineitems_takeda,"LOGSYS,COMP_CODE,CHRT_ACCTS,GL_ACCOUNT,FISCVARNT,FISCPER,AC_DOC_NO,ITEM_NUM","select case when metric > threshold then 1 else 0 end as res from corp_us_lake.dq_output_table where entity_id in ('dq_2411','dq_2412','dq_2413','dq_2414')",P1,0,5
dq_2811,customer_count,com_us_lake,dagg_cdit_redist,row_id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cnt,pr.Name_of_Account_End_Customer as end_customer from (SELECT product_name, CAST(case when source='BD' THEN ship_to_org_id ELSE prescriber_id END) as end_cust_mstr_id, gl_date FROM com_us_lake.dagg_cdit_redist WHERE aud_row_stat_ind='0') sa join com_us_lake.hem_affiliation_table pr on sa.end_cust_mstr_id = pr.Shire_ID_End_Customer join com_us_lake.man_lov lv on sa.product_name = lv.lov_code where to_date(sa.gl_date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.Name_of_Account_End_Customer) cur cross join (select metric, sub_field_name as end_customer from com_us_lake.dq_count_table where rule_key = 2811) prv on cur.end_customer=prv.end_customer)) select * from tmp",P1,10,6
dq_2812,customer_count,com_us_lake,cnp_bd_cbk_sls,row_id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cnt,pr.Name_of_Account_End_Customer as end_customer from (SELECT product_name, CAST(case when source='BD' THEN ship_to_org_id ELSE prescriber_id END) as end_cust_mstr_id, gl_date FROM com_us_lake.cnp_bd_cbk_sls WHERE aud_row_stat_ind='0') sa join com_us_lake.hem_affiliation_table pr on sa.end_cust_mstr_id = pr.Shire_ID_End_Customer join com_us_lake.man_lov lv on sa.product_name = lv.lov_code where to_date(sa.gl_date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.Name_of_Account_End_Customer) cur cross join (select metric, sub_field_name as end_customer from com_us_lake.dq_count_table where rule_key = 2812) prv on cur.end_customer=prv.end_customer)) select * from tmp",P1,10,7
dq_2813,customer_count,com_us_lake,udef_ic_order_adjustments,id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.Name_of_Account_End_Customer as end_customer from (select gl_date,src_id,product from (SELECT product, to_date(gl_date,'MM/dd/yy') gl_date ,customer_master_id src_id FROM com_us_lake.udef_ic_order_adjustments WHERE id is NOT NULL) a join (select   omni_id,cust_profile_key from com_us_hub.ref_cust_profile group by  omni_id,cust_profile_key) f on a.src_id=f.omni_id) sa join com_us_lake.hem_affiliation_table pr on sa.src_id = pr.Shire_ID_End_Customer join com_us_lake.man_lov lv on sa.product = lv.lov_code where to_date(sa.gl_date,'M/d/y') between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) and upper(LOV_DESCRIPTION)='HEMATOLOGY' group by pr.Name_of_Account_End_Customer) cur cross join (select metric, sub_field_name as end_customer from com_us_lake.dq_count_table where rule_key = 2813) prv on cur.end_customer=prv.end_customer)) select * from tmp",P1,10,8
dq_2814,customer_count,com_us_lake,bpri_salesordertransactions,id,"with tmp (select max(abs((cur_cnt-metric)/metric*100)) as metric from ((select count(1) as cur_cnt, pr.Name_of_Account_End_Customer as end_customer from (select COALESCE(omni_id,xref_omni_id,tri_omni_id) id ,* from (select ltrim(0,sold_to_party) src_id, to_date(Billing_doc__date,'M/d/y') gl_date, lv.lov_description Franchise FROM com_us_lake.BPRI_BillingExtract bill JOIN com_us_lake.bpri_salesordertransactions sal ON (regexp_replace(sal.doc_number, '^0+(?!$)', '') = regexp_replace(bill.Sales_document, '^0+(?!$)', '') AND regexp_replace(sal.s_ord_item, '^0+(?!$)', '') = regexp_replace(bill.Sales_doc_Item, '^0+(?!$)', '')) join com_us_lake.man_lov lv ON (regexp_replace(sal.material,'^0+(?!$)', '') = regexp_replace(lv.LOV_CODE,'^0+(?!$)', '') AND lv.ENTITY_TYPE='all' AND lv.LOOKUP_FIELD='franchise_nm'  AND lv.data_source='SAP') where   upper(LOV_DESCRIPTION)='HEMATOLOGY') sub inner join (select distinct rf.omni_id tri_omni_id,ltrim('0',rf.src_id) as src_id from com_us_hub.ref_cust_xref rf left join com_us_lake.feed_lkp feed on upper(rf.src_system)=upper(feed.src_system) where feed.src is not null) sub1 on sub.src_id = sub1.src_id left join (select distinct xrf.omni_id xref_omni_id ,xrf.cust_profile_key,xrf.src_id,upper(feed.src) as feed,upper(xrf.src_system) as src_system from com_us_hub.ref_cust_xref xrf left join  com_us_lake.feed_lkp feed on upper(xrf.src_system)=upper(feed.src_system) where feed.src is not null) sub2 on sub.src_id = sub2.src_id left join (select distinct  omni_id,cust_profile_key from com_us_hub.ref_cust_profile where scd_curr_ind='Y') sub3 on sub.src_id = sub3.omni_id) sa join com_us_lake.hem_affiliation_table pr on sa.id = pr.Shire_ID_End_Customer where sa.gl_date between trunc(current_date, 'mm') and date_add(trunc(add_months(current_date, 1), 'mm'), -1) group by pr.Name_of_Account_End_Customer) cur cross join (select prv_count as prv_cnt,metric, sub_field_name as end_customer from com_us_lake.dq_count_table where rule_key = 2814) prv on cur.end_customer=prv.end_customer)) select * from tmp",P1,10,9
customer_final_check,customer_count,corp_us_lake,generalledger_lineitems_takeda,"LOGSYS,COMP_CODE,CHRT_ACCTS,GL_ACCOUNT,FISCVARNT,FISCPER,AC_DOC_NO,ITEM_NUM","select case when metric > threshold then 1 else 0 end as res from corp_us_lake.dq_output_table where entity_id in ('dq_2811','dq_2812','dq_2813','dq_2814')",P1,0,10
