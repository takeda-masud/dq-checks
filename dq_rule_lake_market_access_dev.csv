dq_check_id,Check,Database_name,table_name,primary_key_cols,sql_fr_run,priority,threshold,run_seq
dq_20712,date_missing,com_us_lake,bpri_salesordertransactions,row_id,"with bpri_salesordertransactions as 


(select * from com_us_lake.bpri_salesordertransactions) ,
BPRI_BillingExtract as 
(select * from com_us_lake.BPRI_BillingExtract
 where to_date(BPRI_BillingExtract.billing_doc__date,'dd/MM/yyyy') > trunc(add_months(current_date,-48),'mm')),

 tmp as(

SELECT  BPRI_BillingExtract.billing_doc__date  GL_DATE
FROM BPRI_BillingExtract BPRI_BillingExtract
INNER JOIN bpri_salesordertransactions

         ON (
         regexp_replace(bpri_salesordertransactions.doc_number,'^0+(?!$)','') = regexp_replace(BPRI_BillingExtract.Sales_document,'^0+(?!$)','') 
         AND regexp_replace(bpri_salesordertransactions.s_ord_item,'^0+(?!$)','') =  regexp_replace(BPRI_BillingExtract.Sales_doc_Item,'^0+(?!$)','')
             )          
          INNER JOIN
com_us_lake.bpri_materialmasterdata
          ON (    
bpri_salesordertransactions.material=bpri_materialmasterdata.material
                     AND bpri_materialmasterdata.logsys in('PRDCLNT100')
		    AND bpri_materialmasterdata.MATL_TYPE in ('FINI','TRAD')
            ) 
       
        
         inner JOIN
        com_us_hub.ref_prd_prod p
        ON(regexp_replace(bpri_materialmasterdata.material,'^0+(?!$)','') = regexp_replace(p.prod_id,'^0+(?!$)','')) 
        
        

         -- where channel_type='SPP'
                  where 
    to_date(BPRI_BillingExtract.billing_doc__date,'dd/MM/yyyy') > trunc(add_months(current_date,-48),'mm')  and                
bpri_salesordertransactions.billtoprty <>'0000336234' 
and (bpri_salesordertransactions.REASON_REJ is null or bpri_salesordertransactions.REASON_REJ = '')
AND bpri_salesordertransactions.doc_type IN ('ZXOA','ZXDR','ZXCR','ZXOE','ZXOR')
AND (bpri_salesordertransactions.STORNO  <> 'R' or bpri_salesordertransactions.STORNO is null or bpri_salesordertransactions.STORNO = '')
AND bpri_salesordertransactions.comp_code  in ('3390','3311','3312')
        -- and Coalesce(lkp.contract_id, lkp2.contract_id)  is  null
  group by       
   BPRI_BillingExtract.billing_doc__date       
        
       
       
      
         
        )
        

select (select   count(distinct actual_date)  from com_us_hub.ref_cal 
where   ( actual_date between  (to_Date(add_months(trunc(current_date, 'MM') , -48),'MM/DD/YYYY')) and  date_add(to_Date(trunc(current_date, 'MM') ,'MM/DD/YYYY'),-1)) and dayofweek(actual_date)  not in(1,7) ) -
--(select count(gl_date) from tmp )

(select count( gl_date)  from tmp
where   ( to_date(gl_date,'dd/MM/yyyy')  between  (to_Date(add_months(trunc(current_date, 'MM') , -48),'dd/MM/yyyy')) and  date_add(to_Date(trunc(current_date, 'MM') ,'MM/DD/YYYY'),-1)) and dayofweek(to_date(gl_date,'dd/MM/yyyy') )  not  in(1,7)
)",P1,0,120
dq_final_check,final_check,corp_us_lake,generalledger_lineitems_takeda,"LOGSYS,COMP_CODE,CHRT_ACCTS,GL_ACCOUNT,FISCVARNT,FISCPER,AC_DOC_NO,ITEM_NUM","select res from (select case when metric > threshold then 1 else 0 end as res,dense_rank() over(partition by  entity_id    order by timestamp(insertdate)) r,timestamp(insertdate)   from corp_us_lake.dq_output_table   where entity_id in ('dq_20711','dq_20712') and to_date(insertdate,'dd/MM/yyyy')=(select max(to_date(insertdate,'dd/MM/yyyy')) from corp_us_lake.dq_output_table where entity_id in ('dq_20712'))) where r=1",P1,0,121
